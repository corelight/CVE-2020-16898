module CVE_2020_16898;
# A network detection package for CVE-2020-16898 (Windows TCP/IP Remote Code Execution Vulnerability)
# Tested on Zeek version 3.3.0-dev.329
# Author: Ben Reardon, Research Team @Corelight. ben.reardon@corelight.com, @benreardon
# Author: Yacin Nadji, Research Team @Corelight. yacin.nadji@corelight.com, @ynadji
# Version: 0.1

const Router_Advertisement = 134;
const Recursive_DNS_Server_Option = 25;

export {
    redef enum Notice::Type += {
        CVE_2020_16898_exploit
    };
}

# Although currently deprecated, the icmp_conn record is being used here to maximize support across older versions. 
# When v4.1 is released, icmp_info record will be replacing icmp_conn.
event icmp_router_advertisement(c: connection, icmp: icmp_conn, cur_hop_limit: count, managed: bool, other: bool, home_agent: bool, pref: count, proxy: bool, rsv: count, router_lifetime: interval, reachable_time: interval, retrans_timer: interval, options: icmp6_nd_options)
    {
    for (element in options)
        {
        if ( icmp$v6 && icmp$itype == Router_Advertisement && options[element]$otype == Recursive_DNS_Server_Option && (options[element]$len % 2) == 0 )
            {
             NOTICE([$note=CVE_2020_16898_exploit,
                    $conn=c,
                    $identifier=cat(c$id$orig_h),
                    $msg=fmt("CVE-2020-16898 exploit detected from %s. https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2020-16898#ID0EUGAC . Details from packet for reference: icmp=%s , options=%s ", c$id$orig_h, icmp, options)]);
            }
        }
    }
